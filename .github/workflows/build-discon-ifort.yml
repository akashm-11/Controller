name: Build DISCON.dll (ifort full automation)

on:
  push:
    paths:
      - "**/*.f90"
      - "**/*.F90"

jobs:
  build:
    # MUST be a self-hosted Windows runner (admin rights required)
    runs-on: self-hosted
    timeout-minutes: 240

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    # ---------------------------
    # 0. quick admin check (best-effort)
    # ---------------------------
    - name: Ensure running as admin (best-effort)
      shell: cmd
      run: |
        whoami /groups | find "S-1-5-32-544" >nul || (
          echo WARNING: This job is not running as Administrator. Installer steps may fail.
        )

    # ---------------------------
    # 1. Download Visual Studio 2022 bootstrapper (if missing)
    # Source from gist - aka.ms stable link for VS 2022 community
    # ---------------------------
    - name: Download Visual Studio 2022 bootstrapper
      shell: cmd
      run: |
        if not exist vs_community.exe (
          echo Downloading Visual Studio 2022 bootstrapper...
          curl -L "https://aka.ms/vs/17/release/vs_community.exe" -o vs_community.exe
        ) else (
          echo vs_community.exe already present
        )

    # ---------------------------
    # 2. Silent install Visual Studio 2022 Desktop C++ workload (if missing)
    # Uses workload id: Microsoft.VisualStudio.Workload.NativeDesktop
    # Important: requires Admin privileges; first run will be slow.
    # ---------------------------
    - name: Install Visual Studio 2022 (Desktop C++ workload) if missing
      shell: cmd
      run: |
        where cl >nul 2>&1 && (
          echo cl.exe found â€” skipping VS install
        ) || (
          echo Running VS bootstrapper (silent) - this may take a long time...
          rem --quiet: no UI, --wait: wait for completion, --norestart: don't auto reboot
          rem add the Desktop C++ workload ID; include recommended components for a C++ build environment
          vs_community.exe --quiet --wait --norestart --add Microsoft.VisualStudio.Workload.NativeDesktop --includeRecommended
          IF %ERRORLEVEL% NEQ 0 (
            echo Visual Studio installer failed with %ERRORLEVEL%
            exit /b %ERRORLEVEL%
          )
        )

    # ---------------------------
    # 3. (Optional) Create local layout advice (comment)
    # If you want deterministic offline installs, create a layout manually ahead of time:
    # vs_community.exe --layout C:\vs_layout --add Microsoft.VisualStudio.Workload.NativeDesktop --includeRecommended --lang en-US
    # ---------------------------

    # ---------------------------
    # 4. Download Intel oneAPI HPC Toolkit (offline) - your provided URL
    # ---------------------------
    - name: Download Intel oneAPI HPC Toolkit (offline EXE)
      shell: cmd
      run: |
        if not exist w_HPCKit.exe (
          echo Downloading Intel HPC Toolkit offline installer...
          curl -L "https://registrationcenter-download.intel.com/akdlm/IRC_NAS/438527fc-7140-422c-a851-389f2791816b/w_HPCKit_p_2023.2.0.49441_offline.exe" -o w_HPCKit.exe
        ) else (
          echo Intel installer already present
        )

    # ---------------------------
    # 5. Silent-install Intel oneAPI (if ifort missing)
    # NOTE: installer accepts EULA and components; running the offline installer silently needs admin.
    # ---------------------------
    - name: Install Intel oneAPI HPC Toolkit (ifort) if missing
      shell: cmd
      run: |
        if exist "C:\Program Files (x86)\Intel\oneAPI\compiler\latest\windows\bin\ifort.exe" (
          echo Intel ifort already installed - skipping
        ) else (
          echo Installing Intel oneAPI HPC toolkit (silent) - requires admin...
          rem The installer supports silent mode and EULA acceptance; component selection is used to reduce install size.
          w_HPCKit.exe -s --eula accept --components intel.oneapi.win.ifort
          IF %ERRORLEVEL% NEQ 0 (
            echo Intel installer failed with %ERRORLEVEL%
            exit /b %ERRORLEVEL%
          )
        )

    # ---------------------------
    # 6. Prepare environment and build DISCON.dll
    # ---------------------------
    - name: Build DISCON.dll with ifort
      shell: cmd
      run: |
        rem load oneAPI environment (intel64)
        call "C:\Program Files (x86)\Intel\oneAPI\setvars.bat" intel64
        rem load VS environment to make sure linkers are available
        where cl >nul 2>&1 || (
          echo "cl.exe not found in PATH - ensure Visual Studio installed and 'cl' is available"
        )
        rem Build command (simple as requested)
        ifort /dll /libs:static DISCON.F90 /link /out:DISCON.dll
        IF %ERRORLEVEL% NEQ 0 (
          echo BUILD FAILED with %ERRORLEVEL%
          exit /b %ERRORLEVEL%
        )
        echo Build complete. DISCON.dll should exist.

    # ---------------------------
    # 7. Upload the resulting DLL
    # ---------------------------
    - name: Upload DISCON.dll
      uses: actions/upload-artifact@v4
      with:
        name: DISCON-dll
        path: DISCON.dll
